<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Audio & PDF Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script> <!-- PDF.js -->
    <style>
        #pdf-container {
            text-align: center;
            margin-top: 20px;
        }
        canvas {
            border: 1px solid black;
            width: 90vw;
            height: 80vh;
            max-width: 1000px;
            max-height: 800px;
        }
        #controls {
            margin-top: 10px;
        }
        button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Your Generated Audio & Uploaded PDF</h1>

    <p id="status">Loading...</p>

    <!-- ‚úÖ Audio Player -->
    <audio id="audioPlayer" controls style="display: none;"></audio>

    <h2>Your Uploaded PDF</h2>

    <!-- ‚úÖ PDF Viewer -->
    <div id="pdf-container">
        <canvas id="pdfCanvas"></canvas>
        <div id="controls">
            <button onclick="prevPage()">Previous</button>
            <span>Page: <span id="pageNum">1</span> / <span id="pageCount">?</span></span>
            <button onclick="nextPage()">Next</button>
        </div>
    </div>

    <script>
        let pdfDoc = null,
            pageNum = 1,
            pageCount = 0,
            params = new URLSearchParams(window.location.search),
            fileurl = params.get("file_url") ? decodeURIComponent(params.get("file_url")) : null,
            audioUrl = params.get("audio_url") ? decodeURIComponent(params.get("audio_url")) : null,
            canvas = document.getElementById("pdfCanvas"),
            ctx = canvas.getContext("2d");
        console.log("pdf link", fileurl);
        console.log("üîç Full Query String:", window.location.search);
        console.log("üîç Extracted PDF URL:", fileurl); // ‚úÖ Debugging log
        console.log("üîç Extracted Audio URL:", audioUrl); // ‚úÖ Debugging log

        async function loadPdf(url) {
            try {
                if (!url) throw new Error("PDF URL is missing.");
                
                console.log("üìÇ Attempting to load PDF from:", url); // ‚úÖ Debugging log
                const pdf = await pdfjsLib.getDocument(url).promise;
                pdfDoc = pdf;
                pageCount = pdf.numPages;
                document.getElementById("pageCount").innerText = pageCount;
                renderPage(pageNum);
            } catch (error) {
                document.getElementById("status").innerText = "Error loading PDF.";
                console.error("‚ùå Error loading PDF:", error);
            }
        }

        async function renderPage(num) {
            if (!pdfDoc) {
                console.error("‚ùå Error: `pdfDoc` is null. PDF not loaded.");
                return;
            }
            console.log(`üìÑ Rendering Page: ${num}`);

            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            document.getElementById("pageNum").innerText = num;
        }

        function nextPage() {
            if (pageNum < pageCount) {
                pageNum++;
                renderPage(pageNum);
            }
        }

        function prevPage() {
            if (pageNum > 1) {
                pageNum--;
                renderPage(pageNum);
            }
        }

        window.onload = function () {
            setTimeout(() => {
                console.log("‚úÖ Page fully loaded. Checking PDF & Audio URLs...");

                // ‚úÖ Load audio
                if (audioUrl) {
                    console.log("üéµ Loading Audio:", audioUrl);
                    console.log("pdf url:",fileurl)
                    document.getElementById("audioPlayer").src = audioUrl;
                    document.getElementById("audioPlayer").style.display = "block";
                } else {
                    console.warn("‚ö†Ô∏è No Audio URL found.");
                }

                // ‚úÖ Load PDF after delay to prevent forced layout issue
                if (fileurl) {
                    console.log("üìÇ Loading PDF...", fileurl);
                    loadPdf(fileurl);
                } else {
                    document.getElementById("status").innerText = "No PDF file found.";
                    console.warn("‚ö†Ô∏è No PDF file URL detected.");
                }
            }, 100); // Small delay to let styles load fully
        };
    </script>
</body>
</html>
